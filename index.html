<!DOCTYPE html>
<html>
    <head>
        <title>ciMonitor</title>
        <link href="css/style.css" rel="stylesheet" type="text/css" />
    </head>

    <body>
		<audio name="sound" id="sound"></audio>
        <div id="builds">
            <ul>
                <li>Contacting build server...</li>
            </ul>
        </div>

        <script src="js/jquery-1.9.1.min.js" type="text/javascript"></script> 
        <script type="text/javascript">

			var sounds = [];
			var soundQueue = {
				add: function (sound_url) {
					sounds.push("sound/" + sound_url + ".mp3");
				},
				play: function () {
					if (sounds.length > 0) {
						var soundPlayer = $("#sound")[0];
						if (soundPlayer.paused) {
							soundPlayer.src = sounds.shift();
							soundPlayer.play();
						}
					}
				}
			};

            $(document).ready(function () {
                var lastData = null;
				var contact = false;
				
                setInterval(function () {
                    $.ajax({
						url: "http://buildslave01/view/All/api/json?format=json&jsonp=?",
                        dataType: "jsonp",
						timeout: 5000
					}).done(function (data) {
						if (!contact) {
							contact = true;
							soundQueue.add("started");
						}
						
						$("#builds ul").html("");
						$(data.jobs).each(function (index) {
							$("#builds ul").append("<li class=\"" + this.color + "\">" + this.name + "</li>");
							
							if (lastData) {
								var transition = transitionFor(this.color, lastData.jobs[index]);
								if (transition)
									soundQueue.add(transition);
							}
						});
						$('body').attr("class", overallStatus(data.jobs));
						lastData = data;
					}).fail(function() {
						if (contact) {
							contact = false;
							soundQueue.add("failed");
						}

						$("#builds ul").html("<li class=\"red\">Error contacting server</li>");
						$('body').attr("class", "error");
					});
					soundQueue.play();
                }, 5000);
            }); 	

			function transitionFor(currentStatus, lastStatus) {
				if (currentStatus=="blue" && lastStatus.color=="blue_anime")
					soundQueue.add("successful");
				if (currentStatus=="blue" && lastStatus.color=="red_anime")
					soundQueue.add("fixed");
				if (currentStatus=="red" && lastStatus.color=="blue_anime")
					soundQueue.add("failed");
				if (currentStatus=="red" && lastStatus.color=="red_anime")
					soundQueue.add("repeatedlyFailing");
				if (currentStatus.match(/_anime$/) && !lastStatus.color.match(/_anime$/))
					soundQueue.add("started");								
			}
            
            function overallStatus(jobs) {
                var statuses = {};
                $(jobs).each(function () {
                    if (!statuses[this.color])
                        statuses[this.color] = 0;
                    statuses[this.color]++;
                });

                if (jobs.length > 0 && jobs.length == statuses["blue"])
                    return "blue";
                if (statuses["red"] > 0 || statuses["aborted"] > 0)
                    return "red";
                if (statuses["unknown"] > 0)
                    return "unknown";
                if (statuses["blue_anime"] > 0)
                    return "blue_anime";
                return "unknown";
            }
        </script>        
    </body>
</html>

