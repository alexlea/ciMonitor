<!DOCTYPE html>
<html>
    <head>
        <title>ciMonitor</title>
        <link href="css/style.css" rel="stylesheet" type="text/css" />
    </head>

    <body>
        <div id="builds">
            <ul>
                <li>Contacting build server...</li>
            </ul>
        </div>

        <script src="js/jquery-1.9.1.min.js" type="text/javascript"></script> 
        <script src="js/soundmanager2-nodebug-jsmin.js" type="text/javascript"></script>
        <script type="text/javascript">
            var soundIds = ["started", "successful", "failed", "fixed", "repeatedlyFailing"];
            soundManager.url = "swf/";
            soundManager.debugMode = false;
            soundManager.onready(function () {
                soundIds.map(function (soundId) {
                    soundManager.createSound({
                        id: soundId,
                        url: "sounds/" + soundId + '.mp3'
                    });
                });
            });

            $(document).ready(function () {
                var lastData = null;
                setInterval(function () {
                    $.ajax({
						url: "http://buildslave01/view/All/api/json?format=json&jsonp=?",
                        dataType: "jsonp",
						timeout: 5000
					}).done(function (data) {
						$("#builds ul").html("");
						$(data.jobs).each(function (index) {
							$("#builds ul").append("<li class=\"" + this.color + "\">" + this.name + "</li>");
							
							if (lastData) {
								if (this.color=="blue" && lastData.jobs[index].color=="blue_anime")
									soundManager.play("successful");
								if (this.color=="blue" && lastData.jobs[index].color=="red_anime")
									soundManager.play("fixed");
								if (this.color=="red" && lastData.jobs[index].color=="blue_anime")
									soundManager.play("failed");
								if (this.color=="red" && lastData.jobs[index].color=="red_anime")
									soundManager.play("repeatedlyFailing");
								if (this.color.match(/_anime$/) && !lastData.jobs[index].color.match(/_anime$/)
									soundManager.play("started");								
							}
						});
						$('body').attr("class", overallStatus(data.jobs));
						
						lastData = data;
						
					}).fail(function() {
						$("#builds ul").html("<li class=\"red\">Error contacting server</li>");
						$('body').attr("class", "error");
					});
                }, 5000);
            }); 		
            
            function overallStatus(jobs) {
                var statuses = {};
                $(jobs).each(function () {
                    if (!statuses[this.color])
                        statuses[this.color] = 0;
                    statuses[this.color]++;
                });

                if (jobs.length > 0 && jobs.length == statuses["blue"])
                    return "blue";
                if (statuses["red"] > 0 || statuses["aborted"] > 0)
                    return "red";
                if (statuses["unknown"] > 0)
                    return "unknown";
                if (statuses["blue_anime"] > 0)
                    return "blue_anime";
                return "unknown";
            }
        </script>        
    </body>
</html>

