<!DOCTYPE html>
<html>
    <head>
        <title>ciMonitor</title>
        <link href="css/style.css" rel="stylesheet" type="text/css" />
    </head>

    <body>
		<audio id="successful" src="sound/successful.mp3"></audio>
		<audio id="failed" src="sound/failed.mp3"></audio>
		<audio id="fixed" src="sound/fixed.mp3"></audio>
		<audio id="started" src="sound/started.mp3"></audio>
		<audio id="repeatedlyFailing" src="sound/repeatedlyFailing.mp3"></audio>
		
        <div id="builds">
            <ul>
                <li>Contacting build server...</li>
            </ul>
        </div>

        <script src="js/jquery-1.9.1.min.js" type="text/javascript"></script> 
        <script type="text/javascript">

            $(document).ready(function () {
                var lastData = null;
                setInterval(function () {
                    $.ajax({
						url: "http://buildslave01/view/All/api/json?format=json&jsonp=?",
                        dataType: "jsonp",
						timeout: 5000
					}).done(function (data) {
						$("#builds ul").html("");
						var transitions = [];
						$(data.jobs).each(function (index) {
							$("#builds ul").append("<li class=\"" + this.color + "\">" + this.name + "</li>");
							
							if (lastData) {
								var transition = transitionFor(this.color, lastData.jobs[index]);
								if (transition)
									transitions.push(transition);
							}
						});
						$(transitions).each(function() {
							$("audio#"+this)[0].play();
						});
						$('body').attr("class", overallStatus(data.jobs));
						lastData = data;
					}).fail(function() {
						$("#builds ul").html("<li class=\"red\">Error contacting server</li>");
						$('body').attr("class", "error");
					});
                }, 5000);
            }); 	

			function transitionFor(currentStatus, lastStatus) {
				if (currentStatus=="blue" && lastStatus.color=="blue_anime")
					return "successful";
				if (currentStatus=="blue" && lastStatus.color=="red_anime")
					return "fixed";
				if (currentStatus=="red" && lastStatus.color=="blue_anime")
					return "failed";
				if (currentStatus=="red" && lastStatus.color=="red_anime")
					return "repeatedlyFailing";
				if (currentStatus.match(/_anime$/) && !lastStatus.color.match(/_anime$/))
					return "started";
				return null;
			}
            
            function overallStatus(jobs) {
                var statuses = {};
                $(jobs).each(function () {
                    if (!statuses[this.color])
                        statuses[this.color] = 0;
                    statuses[this.color]++;
                });

                if (jobs.length > 0 && jobs.length == statuses["blue"])
                    return "blue";
                if (statuses["red"] > 0 || statuses["aborted"] > 0)
                    return "red";
                if (statuses["unknown"] > 0)
                    return "unknown";
                if (statuses["blue_anime"] > 0)
                    return "blue_anime";
                return "unknown";
            }
        </script>        
    </body>
</html>

